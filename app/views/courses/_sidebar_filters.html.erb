<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Filters</h5>
  </div>
  <div class="card-body">
    <%= form_with url: courses_path, method: :get, local: false, 
        data: { 
          controller: "search",
          turbo_frame: "courses_list",
          search_target: "form",
          currency: @current_currency || session[:currency] || 'USD'
        }, 
        class: "mb-4" do |f| %>
        <div class="row g-3">
          <!-- Search bar is kept in the main content area, not in the sidebar -->
          
          <!-- Preserve search query when applying filters -->
          <% if params[:query].present? %>
            <%= f.hidden_field :query, value: params[:query] %>
          <% end %>
          
          <!-- All filter fields moved to sidebar -->
          <% if false %>
          <div class="col-12">
            <%= f.label :department_id, "Department", class: "form-label" %>
            <%= f.select :department_id, 
              options_from_collection_for_select(
                @available_departments,
                :id,
                ->(d) { "#{d.name} (#{@available_departments_counts[d.id] || 0})" },
                params[:department_id]
              ),
              { include_blank: "Department" }, 
              class: "form-select", 
              data: { action: "change->search#search" }
            %>

          </div>
          <% end %>
          <div class="col-12">
            <%= f.label :university_id, "University", class: "form-label" %>
            <%= f.select :university_id, 
              options_from_collection_for_select(
                @available_universities,
                :id,
                ->(u) { "#{u.name} (#{@university_course_counts[u.id] || 0})" },
                params[:university_id]
              ),
              { include_blank: "University" }, 
              class: "form-select", 
              data: { action: "change->search#search" }
            %>
          </div>
          <div class="col-12">
            <%= f.label :university_country, "University Country", class: "form-label" %>
            <%= f.select :university_country,
              options_for_select(
                @available_university_countries.map do |country|
                  ["#{country} (#{@university_country_counts[country] || 0})", country]
                end,
                selected: params[:university_country]
              ),
              { include_blank: "University Country" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>

          </div>
          <div class="col-12">
            <%= f.label :type_of_university, "University Type", class: "form-label" %>
            <%= f.select :type_of_university,
              options_for_select(
                @available_university_types.map do |type|
                  ["#{type} (#{@available_university_types_counts[type] || 0})", type]
                end,
                selected: params[:type_of_university]
              ),
              { include_blank: "University Type" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>
          </div>
          <div class="col-12">
            <%= f.label :university_address, "University Address", class: "form-label" %>
            <div class="position-relative">
              <%= f.text_field :university_address,
                value: params[:university_address],
                placeholder: "Search by address...",
                class: "form-control",
                data: { 
                  search_target: "addressInput",
                  action: "keydown->search#handleAddressKeydown"
                },
                autocomplete: "off"
              %>
              <%= f.hidden_field :latitude, value: params[:latitude], data: { search_target: "latitude" } %>
              <%= f.hidden_field :longitude, value: params[:longitude], data: { search_target: "longitude" } %>
              <div class="invalid-feedback" data-search-target="addressError">
                Please enter a valid address
              </div>
            </div>
            <div class="mt-2">
              <%= f.label :distance, "Search Radius (km)", class: "form-label" %>
              <div class="d-flex align-items-center">
                <%= f.number_field :distance, 
                  value: params[:distance] || 50,
                  placeholder: "Radius",
                  class: "form-control", 
                  data: { 
                    search_target: "distance",
                    action: "change->search#search"
                  } %>
              </div>
            </div>
          </div>
          <div class="col-12">
            <%= f.label :level_of_course, "Level of Course", class: "form-label" %>
            <%= f.select :level_of_course,
              options_for_select(
                @available_levels.map do |available_level|
                  ["#{available_level} (#{@available_levels_counts[available_level] || 0})", available_level]
                end,
                selected: params[:level_of_course]
              ),
              { include_blank: "Level of Course" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>
          </div>
          <div class="col-12">
            <%= f.label :allow_backlogs, "Backlogs Allowed", class: "form-label" %>
            <%= f.select :allow_backlogs,
              options_for_select(
                @available_backlogs.map do |available_backlog|
                  ["#{available_backlog} (#{@available_backlogs_counts[available_backlog] || 0})", available_backlog]
                end,
                selected: params[:allow_backlogs]
              ),
              { include_blank: "Backlogs Allowed" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>
          </div>
          <div class="col-12">
            <%= f.label :lateral_entry_possible, "Lateral Entry", class: "form-label" %>
            <%= f.select :lateral_entry_possible,
              options_for_select(
                @available_lateral_entries.map do |entry|
                  ["#{entry} (#{@available_lateral_entries_counts[entry] || 0})", entry]
                end,
                selected: params[:lateral_entry_possible]
              ),
              { include_blank: "Lateral Entry" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>
          </div>
          <div class="col-12">
            <%= f.label :intake, "Intake", class: "form-label" %>
            <%= f.select :intake,
              options_for_select(
                @available_intakes.map do |intake|
                  ["#{intake} (#{@available_intakes_counts[intake] || 0})", intake]
                end,
                selected: params[:intake]
              ),
              { include_blank: "Intake" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>

          </div>
          <div class="col-12">
            <%= f.label :current_status, "Status", class: "form-label" %>
            <%= f.select :current_status,
              options_for_select(
                @available_statuses.map do |status|
                  ["#{status} (#{@available_statuses_counts[status] || 0})", status]
                end,
                selected: params[:current_status]
              ),
              { include_blank: "Status" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>
          </div>
          <div class="col-12">
            <%= f.label :delivery_method, "Delivery Method", class: "form-label" %>
            <%= f.select :delivery_method,
              options_for_select(
                @available_delivery_methods.map do |delivery_method|
                  ["#{delivery_method} (#{@available_delivery_methods_counts[delivery_method] || 0})", delivery_method]
                end,
                selected: params[:delivery_method]
              ),
              { include_blank: "Delivery Method" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>
          </div>
          <div class="col-12">
            <%= label_tag :tag_id, "Tag", class: "form-label" %>
            <%= f.select :tag_id,
              options_for_select(
                @available_tags.map do |tag|
                  tag_name = tag.tag_name || 'NIL-TAG'  # Handle nil tag_name
                  count = @available_tags_counts[tag.id.to_s] || 0  # Use 0 if no count is found for the tag
                  ["#{tag_name} (#{count})", tag.id]
                end,
                selected: params[:tag_id]
              ),
              { include_blank: "Tag" },
              class: "form-select",
              data: { action: "change->search#search" }
            %>

          </div>
          <div class="col-12">
          <%= f.label :min_tuition_fee, "Tuition Fee", class: "form-label" %>
          <div class="d-flex align-items-center">
            <% [:min_tuition_fee, :max_tuition_fee].each_with_index do |field, index| %>
              <div class="input-group input-group-sm <%= 'me-2' if index == 0 %>">
                <span class="input-group-text"><%= currency_symbol %></span>
                <%= f.number_field field,
                      value: params[field],
                      placeholder: index.zero? ? "Min" : "Max",
                      class: "form-control",
                      data: {
                        search_target: "#{field.to_s.camelize(:lower)}",
                        action: "change->search#search"
                      } %>
              </div>
              <%== '<span class="mx-2">-</span>' if index.zero? %>
            <% end %>
          </div>
          <div class="mt-2">
            <input type="range" 
              class="form-range"
              min="0" 
              max="<%= convert_currency(100_000, 'USD', session[:currency]) %>"
              step="<%= convert_currency(1_000, 'USD', session[:currency]) %>"
              data-search-target="tuitionFeeSlider"
              data-action="change->search#updateTuitionFeeInputs"
              value="<%= params[:max_tuition_fee] || convert_currency(100_000, 'USD', session[:currency]) %>">
          </div>
        </div>
          <div class="col-12">
            <%= f.label :internship_period, "Internship Period", class: "form-label" %>
            <div class="d-flex align-items-center">
              <%= f.number_field :min_internship, 
                value: params[:min_internship],
                placeholder: "Min",
                class: "form-control form-control-sm me-2", 
                data: { 
                  search_target: "minInternship",
                  action: "change->search#search"
                } %>
              <span class="mx-2">-</span>
              <%= f.number_field :max_internship, 
                value: params[:max_internship],
                placeholder: "Max",
                class: "form-control form-control-sm", 
                data: { 
                  search_target: "maxInternship",
                  action: "change->search#search"
                } %>
            </div>
            <div class="mt-2">
              <input type="range" 
                class="form-range" 
                min="0" 
                max="24" 
                step="1"
                data-search-target="internshipSlider"
                data-action="change->search#updateInternshipInputs"
                value="<%= params[:max_internship] || 24 %>">
            </div>
          </div>
          <div class="col-12">
          <%= f.label :min_world_ranking, "World Ranking", class: "form-label" %>
          <div class="d-flex align-items-center">
            <%= f.number_field :min_world_ranking, 
              value: params[:min_world_ranking],
              placeholder: "Min",
              class: "form-control form-control-sm me-2", 
              data: { 
                search_target: "minWorldRanking",
                action: "change->search#search"
              } %>
            <span class="mx-2">-</span>
            <%= f.number_field :max_world_ranking, 
              value: params[:max_world_ranking],
              placeholder: "Max",
              class: "form-control form-control-sm", 
              data: { 
                search_target: "maxWorldRanking",
                action: "change->search#search"
              } %>
          </div>
          <div class="mt-2">
            <input type="range" 
              class="form-range" 
              min="0" 
              max="1000" 
              step="10"
              data-search-target="worldRankingSlider"
              data-action="change->search#updateWorldRankingInputs"
              value="<%= params[:max_world_ranking] || 1000 %>">
          </div>
        </div>
        <div class="col-12">
          <%= f.label :min_qs_ranking, "QS Ranking", class: "form-label" %>
          <div class="d-flex align-items-center">
            <%= f.number_field :min_qs_ranking, 
              value: params[:min_qs_ranking],
              placeholder: "Min",
              class: "form-control form-control-sm me-2", 
              data: { 
                search_target: "minQsRanking",
                action: "change->search#search"
              } %>
            <span class="mx-2">-</span>
            <%= f.number_field :max_qs_ranking, 
              value: params[:max_qs_ranking],
              placeholder: "Max",
              class: "form-control form-control-sm", 
              data: { 
                search_target: "maxQsRanking",
                action: "change->search#search"
              } %>
          </div>
          <div class="mt-2">
            <input type="range" 
              class="form-range" 
              min="0" 
              max="1000" 
              step="10"
              data-search-target="qsRankingSlider"
              data-action="change->search#updateQsRankingInputs"
              value="<%= params[:max_qs_ranking] || 1000 %>">
          </div>
        </div>
        <div class="col-12">
          <%= f.label :min_national_ranking, "National Ranking", class: "form-label" %>
          <div class="d-flex align-items-center">
            <%= f.number_field :min_national_ranking, 
              value: params[:min_national_ranking],
              placeholder: "Min",
              class: "form-control form-control-sm me-2", 
              data: { 
                search_target: "minNationalRanking",
                action: "change->search#search"
              } %>
            <span class="mx-2">-</span>
            <%= f.number_field :max_national_ranking, 
              value: params[:max_national_ranking],
              placeholder: "Max",
              class: "form-control form-control-sm", 
              data: { 
                search_target: "maxNationalRanking",
                action: "change->search#search"
              } %>
          </div>
          <div class="mt-2">
            <input type="range" 
              class="form-range" 
              min="0" 
              max="500" 
              step="5"
              data-search-target="nationalRankingSlider"
              data-action="change->search#updateNationalRankingInputs"
              value="<%= params[:max_national_ranking] || 500 %>">
          </div>
        </div>
        <div class="col-12">
          <%= f.label :course_duration, "Duration", class: "form-label" %>
          <div class="d-flex align-items-center">
            <%= f.number_field :min_duration, 
              value: params[:min_duration],
              placeholder: "Min",
              class: "form-control form-control-sm me-2", 
              data: { 
                search_target: "minDuration",
                action: "change->search#search"
              } %>
            <span class="mx-2">-</span>
            <%= f.number_field :max_duration, 
              value: params[:max_duration],
              placeholder: "Max",
              class: "form-control form-control-sm", 
              data: { 
                search_target: "maxDuration",
                action: "change->search#search"
              } %>
          </div>
          <div class="mt-2">
            <input type="range" 
              class="form-range" 
              min="0" 
              max="48" 
              step="1"
              data-search-target="durationSlider"
              data-action="change->search#updateDurationInputs"
              value="<%= params[:max_duration] || 48 %>">
          </div>
        </div>
        <div class="col-12">
        <%= f.label :application_fee, "Application Fee", class: "form-label" %>
        <div class="d-flex align-items-center">
          <% [:min_application_fee, :max_application_fee].each_with_index do |field, index| %>
            <div class="input-group input-group-sm <%= 'me-2' if index == 0 %>">
              <span class="input-group-text"><%= currency_symbol %></span>
              <%= f.number_field field,
                    value: params[field],
                    placeholder: index.zero? ? "Min" : "Max",
                    class: "form-control",
                    data: {
                      search_target: "#{field.to_s.camelize(:lower)}",
                      action: "change->search#search"
                    } %>
            </div>
            <%== '<span class="mx-2">-</span>' if index.zero? %>
          <% end %>
        </div>
        <div class="mt-2">
          <input type="range" 
            class="form-range"
            min="0"
            max="<%= convert_currency(500, 'USD', session[:currency]) %>"
            step="<%= convert_currency(10, 'USD', session[:currency]) %>"
            data-search-target="applicationFeeSlider"
            data-action="change->search#updateApplicationFeeInputs"
            value="<%= params[:max_application_fee] || convert_currency(500, 'USD', session[:currency]) %>">
        </div>
      </div>
        </div>
      <% end %>
  </div>
</div>

<style>
  /* Google Places Autocomplete styles */
  .pac-container {
    z-index: 1050;
    border-radius: 0.375rem;
    margin-top: 2px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }
  
  .pac-item {
    padding: 8px 12px;
    cursor: pointer;
  }
  
  .pac-item:hover {
    background-color: #f8f9fa;
  }
  
  .pac-item-selected {
    background-color: #e9ecef;
  }
  
  /* Prevent address input from showing browser's default autocomplete */
  input[data-search-target="addressInput"] {
    background-color: #ffffff !important;
  }

  /* Fallback styles when Google Maps is not available */
  .google-maps-unavailable .pac-container {
    display: none !important;
  }

  .google-maps-unavailable input[data-search-target="addressInput"] {
    background-color: #f8f9fa !important;
  }
</style> 